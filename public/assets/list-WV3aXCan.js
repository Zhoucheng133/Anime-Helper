import{C as K,u as N,E as O,e as r,G as R,n as l,p as f,q as a}from"./index-DIiYULlP.js";import{n as W}from"./index.browser-BOSKGvW6.js";const J=K("list",()=>{const u=N(),C=O();function S(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function k(e,t,s){const n=S(new Date(e)),o=(s-1)*7,d=(n.getDay()-t+7)%7,m=o+d;return new Date(n.getTime()-m*24*60*60*1e3).getTime()}function y(e){const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime()-e,o=Math.floor(n/(1e3*60*60*24)),c=Math.floor(o/7);return Math.max(c,0)+1}const E=r([{name:"所有",code:"none"},{name:"进行中",code:"progress"},{name:"更新中",code:"onUpdate"},{name:"已完结",code:"updateDone"},{name:"已看完",code:"watchDone"},{name:"搜索",code:"search"},{name:"更新周",code:"weekday"}]),w=r(E.value[1]),h=r([{name:"星期一",code:1},{name:"星期二",code:2},{name:"星期三",code:3},{name:"星期四",code:4},{name:"星期五",code:5},{name:"星期六",code:6},{name:"星期日",code:0}]),q=new Date().getDay(),$=r(h.value.find(e=>e.code===(q||0))??h.value[0]),I=r(0),D=r(""),M=r(0),L=r(20),P=r([]);async function i(e=!1){const{data:t}=await l.get(`${f}/api/list/get`,{params:{offset:M.value,limit:L.value,filter:w.value.code,param:w.value.code=="weekday"?$.value.code:D.value},headers:{token:a().token}});if(t.ok)P.value=t.msg.data,I.value=t.msg.length;else if(t.msg=="令牌已过期"&&!e&&await a().refreshToken()){i(!0);return}}function U(e){return e==0?"/":new Date(e).toLocaleString("zh-CN",{weekday:"long"})}function Y(e){return e.time==0?!1:y(e.time)<e.episode}function v(e){return e.time==0||y(e.time)>e.episode?e.episode:y(e.time)}function G(e){return e.now/v(e)*100}R(D,()=>{w.value.code=="search"&&i()});async function F(e,t=!1){if(e.now>=v(e))return;const{data:s}=await l.post(`${f}/api/list/edit`,{data:{...e,now:e.now+1}},{headers:{token:a().token}});if(s.ok)i();else if(s.msg=="令牌已过期"){if(!t&&await a().refreshToken()){F(e,!0);return}}else u.add({severity:"error",summary:"更新失败",detail:s.msg,life:3e3})}async function j(e,t=!1){if(e.now<=0)return;const{data:s}=await l.post(`${f}/api/list/edit`,{data:{...e,now:e.now-1}},{headers:{token:a().token}});if(s.ok)i();else if(s.msg=="令牌已过期"){if(!t&&await a().refreshToken()){j(e,!0);return}}else u.add({severity:"error",summary:"更新失败",detail:s.msg,life:3e3})}async function b(e,t,s,n,o,c,d=!1){const m=Date.now(),p={id:W(),title:e,episode:s,now:n,time:t?k(m,c,o):0},{data:g}=await l.post(`${f}/api/list/add`,{data:p},{headers:{token:a().token}});if(g.ok)i();else if(g.msg=="令牌已过期"){if(!d&&await a().refreshToken()){b(e,t,s,n,o,c,!0);return}}else u.add({severity:"error",summary:"添加失败",detail:g.msg,life:3e3})}async function x(e,t,s,n,o,c,d,m=!1){const p=Date.now(),g={id:e,title:t,episode:n,now:o,time:s?k(p,d,c):0},{data:T}=await l.post(`${f}/api/list/edit`,{data:g},{headers:{token:a().token}});if(T.ok)i();else if(T.msg=="令牌已过期"){if(!m&&await a().refreshToken()){x(e,t,s,n,o,c,d,!0);return}}else u.add({severity:"error",summary:"更新失败",detail:T.msg,life:3e3})}async function z(e,t=!1){const{data:s}=await l.delete(`${f}/api/list/del/${e.id}`,{headers:{token:a().token}});if(s.ok)i();else if(s.msg=="令牌已过期"){if(!t&&await a().refreshToken()){z(e,!0);return}}else u.add({severity:"error",summary:"删除失败",detail:s.msg,life:3e3})}function H(e,t){C.require({target:e.currentTarget,position:"bottomleft",message:"你确定要删除这项吗",rejectProps:{label:"取消",severity:"secondary",outlined:!0,size:"small"},acceptProps:{label:"删除",severity:"danger",size:"small"},accept:()=>z(t),reject:()=>{}})}return{deleteItem:H,editItem:x,addItem:b,getTimestampOfFirstEpisode:k,add:F,minus:j,searchKeyWord:D,calProgress:G,analyseEpisode:v,calculateEpisodesReleased:y,offset:M,getWeekday:U,onUpudate:Y,selectedFilter:w,filters:E,selectedWeekday:$,weekdays:h,length:I,list:P,getList:i}});export{J as l};
