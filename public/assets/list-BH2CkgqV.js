import{z as N,u as O,C as R,e as r,D as W,v as l,x as f,y as n}from"./index-CElAko20.js";import{n as A}from"./index.browser-Dpc55prd.js";const H=N("list",()=>{const u=O(),C=R();function S(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function k(e,t,s){const a=S(new Date(e)),o=(s-1)*7,d=(a.getDay()-t+7)%7,m=o+d;return new Date(a.getTime()-m*24*60*60*1e3).getTime()}function y(e){const t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime()-e,o=Math.floor(a/(1e3*60*60*24)),c=Math.floor(o/7);return Math.max(c,0)+1}const $=r([{name:"所有",code:"none"},{name:"进行中",code:"progress"},{name:"更新中",code:"onUpdate"},{name:"已完结",code:"updateDone"},{name:"已看完",code:"watchDone"},{name:"搜索",code:"search"},{name:"更新周",code:"weekday"}]),w=r($.value[1]),h=r([{name:"星期一",code:1},{name:"星期二",code:2},{name:"星期三",code:3},{name:"星期四",code:4},{name:"星期五",code:5},{name:"星期六",code:6},{name:"星期日",code:0}]),L=new Date().getDay(),E=r(h.value.find(e=>e.code===(L||0))??h.value[0]),M=r(0),D=r(""),P=r(0),U=r(20),F=r([]);async function i(e=!1){const{data:t}=await l.get(`${f}/api/list/get`,{params:{offset:P.value,limit:U.value,filter:w.value.code,param:w.value.code=="weekday"?E.value.code:D.value},headers:{token:n().token}});if(t.ok)F.value=t.msg.data,M.value=t.msg.length;else if(t.msg=="令牌已过期"&&!e&&await n().refreshToken()){i(!0);return}}function Y(e){return e==0?"/":new Date(e).toLocaleString("zh-CN",{weekday:"long"})}function q(e){return e.time==0?!1:y(e.time)<e.episode}function v(e){return e.time==0||y(e.time)>e.episode?e.episode:y(e.time)}function K(e){return e.now/v(e)*100}W(D,()=>{w.value.code=="search"&&i()});async function I(e,t=!1){if(e.now>=v(e))return;const{data:s}=await l.post(`${f}/api/list/edit`,{data:{...e,now:e.now+1}},{headers:{token:n().token}});if(s.ok)i();else if(s.msg=="令牌已过期"){if(!t&&await n().refreshToken()){I(e,!0);return}}else u.add({severity:"error",summary:"更新失败",detail:s.msg,life:3e3})}async function j(e,t=!1){if(e.now<=0)return;const{data:s}=await l.post(`${f}/api/list/edit`,{data:{...e,now:e.now-1}},{headers:{token:n().token}});if(s.ok)i();else if(s.msg=="令牌已过期"){if(!t&&await n().refreshToken()){j(e,!0);return}}else u.add({severity:"error",summary:"更新失败",detail:s.msg,life:3e3})}async function x(e,t,s,a,o,c,d=!1){const m=Date.now(),p={id:A(),title:e,episode:s,now:a,time:t?k(m,c,o):0},{data:g}=await l.post(`${f}/api/list/add`,{data:p},{headers:{token:n().token}});if(g.ok)i();else if(g.msg=="令牌已过期"){if(!d&&await n().refreshToken()){x(e,t,s,a,o,c,!0);return}}else u.add({severity:"error",summary:"添加失败",detail:g.msg,life:3e3})}async function z(e,t,s,a,o,c,d,m=!1){const p=Date.now(),g={id:e,title:t,episode:a,now:o,time:s?k(p,d,c):0},{data:T}=await l.post(`${f}/api/list/edit`,{data:g},{headers:{token:n().token}});if(T.ok)i();else if(T.msg=="令牌已过期"){if(!m&&await n().refreshToken()){z(e,t,s,a,o,c,d,!0);return}}else u.add({severity:"error",summary:"更新失败",detail:T.msg,life:3e3})}function b(e,t,s=!1){C.require({target:e.currentTarget,position:"bottomleft",message:"你确定要删除这项吗",rejectProps:{label:"取消",severity:"secondary",outlined:!0,size:"small"},acceptProps:{label:"删除",severity:"danger",size:"small"},accept:async()=>{const{data:a}=await l.delete(`${f}/api/list/del/${t.id}`,{headers:{token:n().token}});if(!a.ok)u.add({severity:"error",summary:"删除失败",detail:a.msg,life:3e3});else if(a.msg=="令牌已过期"){if(!s&&await n().refreshToken()){b(e,t,!0);return}}else i()},reject:()=>{}})}return{deleteItem:b,editItem:z,addItem:x,getTimestampOfFirstEpisode:k,add:I,minus:j,searchKeyWord:D,calProgress:K,analyseEpisode:v,calculateEpisodesReleased:y,offset:P,getWeekday:Y,onUpudate:q,selectedFilter:w,filters:$,selectedWeekday:E,weekdays:h,length:M,list:F,getList:i}});export{H as l};
